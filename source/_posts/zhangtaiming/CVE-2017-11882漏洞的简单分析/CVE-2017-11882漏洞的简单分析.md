---
title: CVE-2017-11882漏洞的简单分析
author: St
categories:
- 漏洞分析
- St
tags: 
- CVE-2017-11882 
date: 2020-05-22 
excerpt: CVE-2017-11882是微软公布的一个远程执行漏洞，通杀目前市面上的所有office版本及Windows操作系统。 
---

# 漏洞描述

​	CVE-2017-11882 是微软公布的一个远程执行漏洞，通杀目前目前市面上所有的office版本及Windows操作系统。该漏洞的成因是 EQNEDT32.EXE 进程在读入包含 MathType 的 ole 数据时，在拷贝公式字体名称时没有对名称长度进行校验，从而造成栈缓冲区溢出，是一个非常经典的栈溢出漏洞。目前依旧存在大量利用该漏洞的病毒。

# 漏洞复现

- poc MD5：c5117ac5232ed7980d1672b820ac1a8d

- 漏洞环境：office 2013（需确定存在公式编辑器）

打开poc文件，调用 Word 文档的同时，也会弹出计算器。

![ALt text](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/漏洞复现.png)

# 漏洞成因

该漏洞出现在 windows 的公式编辑器模块中，模块进程名为 EQNEDT32.EXE。弹出计算器的时候创建了新进程，所以可能是由 WinExec 或者 CreateProcess 两个函数创建的。所以先用调试器 OllDbg 附加 EQNEDT32.EXE，然后在两个函数处下 API 断点，载入样本文件。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/定位漏洞函数1.png)



文件在 WinExec 函数的断点上，查看堆栈可知函数的主要目的是通过 cmd.exe 进程来打开计算器。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/定位漏洞函数2.png)

在堆栈中向上搜寻，找到入栈地址。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/定位漏洞函数3.png)

反汇编窗口中跟随，并在上层函数的起始地址处下断点，重新运行程序，将程序断在此处。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/定位漏洞函数4.png)

断点停下后，查看该处的堆栈空间，可以看到当前堆栈未被破坏，并找到当前函数的返回地址。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/找到返回地址.png)

为了找到触发栈溢出的指令，在函数的返回地址处下硬件写入断点后，继续执行程序。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/定位溢出指令.png)

上图中可以发现，已经发生栈溢出，堆栈被破坏，写入了其他信息，返回地址也被改变。

通过 IDA 静态分析 EQNEDT32.EXE，找到 0x411658 位置，通过 F5 查看伪代码。

![](/pic/zhangtaiming/CVE-2017-11882漏洞的简单分析/溢出代码.png)

可以发现，在求得字符串的长度后，没有做长度校验，且没有使用安全版本的字符串拷贝，导致出现了溢出的情况。