---
title: 简单探究命令提示符
author: St
categories:
- 命令提示符
- St
tags: 
- 命令提示符 
date: 2020-06-28 
excerpt: 简单探究一下命令提示符背后的运作机制，主要包括启动外部程序时查找程序位置的顺序，以及对程序的后缀名的处理逻辑。 
---

# 前言

​	我们经常通过命令提示符来执行一些操作，通过 `ipconfig` 来查看 `ip` 信息，执行 `regedit` 来查看编辑注册表，或者是以带参数的形式来打开某些程序。但是，为什么输入简单的几个字母就能够启动外部程序，这些外部程序的文件路径在哪里，是按照什么顺序进行查找的，相同名称不同后缀的程序又会优先执行哪个？下面我们通过一些简单的实验来探究这些问题。

# 查找顺序

​	我们先来探究，命令提示符执行外部程序时，是在哪里查找程序文件的，以及查找的顺序是怎样的。

​	首先，在命令提示符中输入一个不存在的命令（比如，`St`），使用 `Process Monitor` 观察整个过程。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/不存在的命令.png)

​	不出所料，找不到程序。不过，此时我们可以通过 `Process Monitor` 来观察查找文件时`cmd`进程的具体操作。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/不存在的命令promon.png)

​	在 `Process Monitor` 中我们可以发现，`cmd `进程先在当前路径进行了查找，然后是系统路径，最后是几个系统中安装的程序的路径。所以，我猜测可能和 `PATH` 环境变量相关。

​	查看系统的当前 `PATH `环境变量。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/环境变量.png)

​	对照后，可以发现在 `Process Monitor` 中 `cmd `进程的查找顺序和` PATH` 环境变量的顺序相同。

​	为了进一步验证，添加一条不存在的路径到 PATH 环境变量中，然后再次执行不存在的命令（比如，`St`）。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/添加不存在的路径到环境变量.png)

​	此时再通过 Process Monitor 观察。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/添加不存在的路径到环境变量promon.png)

​	可以发现，相比之前，最后多了一条对新添的的不存在的路径的查找。而且因为该路径并不存在，所以没有后面文件的查找，只有一条对路径的判断操作。

​	目前为止，基本可以确定命令提示符执行外部程序时的查找为止以及顺序。即现在当前路径下进行查找，如果找不到则根据 PATH 环境变量的顺序依次去查找。

## 后缀名的处理顺序

​	在上面的实验过程中，相信又细心的朋友发现了，查找不存在的命令式，`cmd` 进程会直接通过 `St.*` 的形式来排除后缀名的影响。所以我们现在一个确实存在的进程，来观察命令提示符对后缀名的处理逻辑。

​	首先，自己先生成一个小程序 `St.exe`，程序很简单，仅执行一个 `pause` 命令。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/文件运行示意.png)

​	然后，将文件放在命令提示符的当前路径下。在命令提示符中执行 `St`。观察  `Process Monitor` 。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/EXE运行promon.png)

​	可以发现，`cmd` 程序在通过 `St.*` 找文件后，会先查找 `St.COM` ,没找到才会继续查找 `St.EXE` 。因为之前查找文件路径的顺序和 `PATH` 环境变量有关，所以这里会不会和 `PATHEXT` 环境变量有关系呢？让我们来看一下 `PATHEXT` 环境变量的内容。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/PATHEXT环境变量.png)

​	我们发现在 `PATHEXT` 环境变量中， `.COM` 出现在 `.EXE` 之前，和 `cmd`进程的查找顺序相同。

​	为了进一步确定，我们调整一下 `PATHEXT` 的值为 `.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.EXE;.COM`。如果和 `PATHEXT` 环境变量，那么此时会先查找`.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;`等后缀名，然后执行`.EXE`,不会查找`.COM`的后缀名。

​	再次运行 `St.exe`命令，观察 `Process Monitor` ，查看运行结果。

![ALt text](/pic/zhangtaiming/简单探究命令提示符/修改PATHEXT.png)

​	通过`Process Monitor`可以发现，这次的 `cmd` 程序，先查找了前面的后缀名，才运行的 `St.exe`，并且没有查找 `.COM`后缀名，和之前的猜测一致。

​	所以，我们可以确定。在命令提示符中，如果输入的命令不带后缀，那么会根据 `PATHEXT` 指示的后缀顺序依次拼接成完整名称再查找。

# 总结

​	相信通过上面一系列的实验，我们对命令提示符如何执行一个外部命令有了一定的认识。`PATH` 环境变量决定了外部命令所在位置的查找顺序，`PATHEXT`环境变量决定了外部命令的后缀名的查找顺序。

​	当我们在命令提示符中输入一个命令时，会先到当前路径中查找，如果找不到，才会到环境变量 `PATH` 指示的路径中查找。如果输入的命令不带后缀，那么会根据 `PATHEXT` 指示的后缀顺序依次拼接成完整名称再查找。

