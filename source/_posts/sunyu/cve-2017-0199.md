---
title: CVE-2017-0199
author: 此生汝梦 
categories:
- 漏洞分析
tags: 
- cve-2017-0199
date: 2020-11-29
excerpt: 对cve-2017-0199的复现和简单讲解
---

# 前言

cve-2017-0199是一个远程代码执行漏洞，当用户打开攻击者构建的恶意文档时，会从远程服务器自动下载并执行脚本。本文在这里简单介绍一下该漏洞的原理和利用手法。

# 简介

cve-2017-0199是于2017年4月11日发布的首个Microsoft Office RTF漏洞，从Microsoft Office 2007到Microsoft Office 2016皆受影响。

cve-2017-0199的成因是因为word在通过网络更新对象时，没有正确处理Content-Type。

# 环境

操作系统：Windows7 32 位

Microsoft Office版本：Office Professional Plus 2016 （msdn.itellyou.cn）

服务器：phpStudy（8.0）集成环境

# 漏洞成因

通过查询资料，可以得知，cve-2017-0199是因为word远程更新数据时会先把远端数据放到临时文件中，然后通过Urlmon模块中的“GetClassFileOrMimeinternal”函数获取运行该文件的com组件的CLSID。

“GetClassFileOrMimeinternal”会优先通过“content/type”获取CLSID,如果获取失败才会通过后缀名获取CLSID。

创建COM实例后，就会将下载的数据传递给实例。

如果下载的文件为*.rtf，但是“content/type”却为hta，那么Word就会创建hta实例，也就是“mshta.exe”进程，然后将下载的文件作为参数传给”mshta.exe“。

这时如果下载的文件，名称为*.rtf，内容确是hta代码，就实现了远程执行代码。



# 利用复现

1. 首先在作为攻击机的虚拟机中安装集成环境。这里选用phpStudy 相对简单。

   ![image-20201020154525588](/pic/sunyu/cve-2017-0199/image-20201020154525588.png)

2. 在服务器根目录下创建一个正常的rtf文件

   ![image-20201021154706744](/pic/sunyu/cve-2017-0199/image-20201021154706744.png)

   ![image-20201021154842452](/pic/sunyu/cve-2017-0199/image-20201021154842452.png)

3. 在桌面创建一个rtf并插入服务器上的rtf文件

   插入→对象→有文件创建（记得勾选连接到文件）![image-20201021155352839](/pic/sunyu/cve-2017-0199/image-20201021155352839.png)

   插入成功之后保存文件

   ![image-20201021155450017](/pic/sunyu/cve-2017-0199/image-20201021155450017.png)

4. 关闭服务器，修改服务器配置

   1. 集成环境面板找到首页，关闭Apache2.4.39

      ![image-20201021160110353](/pic/sunyu/cve-2017-0199/image-20201021160110353.png)

   2. 找到设置→文件位置→Apache

      ![image-20201021160219080](/pic/sunyu/cve-2017-0199/image-20201021160219080.png)

   3. 在打开的窗口中找到conf文件夹，在conf文件夹下找到mime.types文件

      ![image-20201021160343169](/pic/sunyu/cve-2017-0199/image-20201021160343169.png)

   4. 使用Notepad++打开，找到 application/rtf 将其修改为application/hta(后面跟着的rtf不要动，如图)

      ![image-20201021161014737](/pic/sunyu/cve-2017-0199/image-20201021161014737.png)

      ![image-20201021161125668](/pic/sunyu/cve-2017-0199/image-20201021161125668.png)

5. 替换服务器内的rtf内容为HTA语法结构的远程执行代码

   使用Notepad++ 打开服务器根目录下的1.rtf，并将其中的内容替换为

   ```
   <script>
   var a = new ActiveXObject("wscript.shell");
   a.Run("%SystemRoot%\\system32\\calc.exe");
   </script>
   ```

   （此处替换的内容即为远程执行的恶意代码，语法为html语法。）

   此时为了测试替换的代码含义为弹出计算器。

   ![image-20201021161906133](/pic/sunyu/cve-2017-0199/image-20201021161906133.png)

6. 重启服务器

7. 打开此前创建的RTF文件

   1. ![image-20201021162140345](/pic/sunyu/cve-2017-0199/image-20201021162140345.png)

   2. 选择“是”，更新文档，然后双击插入对象（对着测试内容这个几个字双击），双击后弹出如下内容。

      ![image-20201021163159377](/pic/sunyu/cve-2017-0199/image-20201021163159377.png)

8. 此时就可以将在桌面构建的RTF文件放到其他装有office2003-2016 且没打补丁，能访问到自搭服务器的电脑上了，满足以上条件的电脑打开该文档时双击对象时便会弹出计算器了。

9. 如果想实现打开文档时，自动更新加载链接对象，弹出计算器，就需要利用rtf文档的一个强制更新特性objupdate。

   1. 使用notepad++打开构建的文档，搜索\object\objautlink\rsltpict\，然后将其改成\object\objautlink\objupdate\rsltpict\ 

      ![image-20201021165519696](/pic/sunyu/cve-2017-0199/image-20201021165519696.png)

   2. 此时打开效果

      ![image-20201021165644140](/pic/sunyu/cve-2017-0199/image-20201021165644140.png)



# 注意事项

   - 如果在尝试打开或插入对象时出现以下弹窗

   ![image-20201021095053670](/pic/sunyu/cve-2017-0199/image-20201021095053670.png)

   说明在构建系统环境时，安装office2016之前，没有将系统补丁打全（即使用微软自带的自动更新安装完所有补丁后，再安装office2016,且再安装office2016后不更新后续补丁）。

   - 如果在尝试打开插入的rtf对象时，没有反应或打开方式错误（弹窗，弹窗内容为rtf文档的文本模式）

     说明没有清理浏览器缓存。

     ![image-20201021170223652](/pic/sunyu/cve-2017-0199/image-20201021170223652.png)

     ![image-20201021170235602](/pic/sunyu/cve-2017-0199/image-20201021170235602.png)

     此处注意，清理第三方浏览器，如谷歌浏览器的缓存没有用，必须清理IE的缓存（并没有测试使用egde替代IE后，清理edge浏览器的缓存是否有用）

# 参考链接

- https://zerokeeper.com/penetration/cve20170199-office-rtf-replication-process.html
- http://www.lcx4.com/?post=162

